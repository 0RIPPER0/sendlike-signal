<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SendLike — P2P File Share (LAN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="wrap">
    <h1>SendLike — P2P File Share (Local WiFi)</h1>
    <p class="muted">Socket.IO for signaling only. File bytes go peer-to-peer via WebRTC.</p>

    <section class="me">
      <div><strong>Your name:</strong> <span id="myName">…</span></div>
      <div><strong>Your id:</strong> <span id="myId">…</span></div>
    </section>

    <section>
      <h2>Peers</h2>
      <div id="peers" class="peers"></div>
    </section>

    <section>
      <h2>Transfer</h2>
      <div class="controls">
        <input id="fileInput" type="file" multiple hidden />
        <button id="pickFileBtn">Pick file(s)</button>
        <select id="peerSelect"><option value="">Select peer</option></select>
        <button id="connectBtn">Connect / Offer</button>
        <div id="status" class="status">Idle</div>
      </div>
      <div id="transfers" class="transfers"></div>
    </section>

    <footer class="muted small">
      Using STUN only. If NAT traversal fails across networks, deploy a TURN server.
    </footer>
  </main>

  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- P2P core -->
  <script src="script.js"></script>

  <script>
    // --- Bind minimal UI to SL core ---
    const myNameEl   = document.getElementById("myName");
    const myIdEl     = document.getElementById("myId");
    const peersEl    = document.getElementById("peers");
    const peerSelect = document.getElementById("peerSelect");
    const pickBtn    = document.getElementById("pickFileBtn");
    const fileInput  = document.getElementById("fileInput");
    const connectBtn = document.getElementById("connectBtn");
    const statusEl   = document.getElementById("status");

    const { id, name } = SL.init(); // returns placeholder id (may be null until socket connects)
    myNameEl.textContent = name;

    // Update my ID once socket connects (fixes blank ID)
    SL.on("socket:connect", ({ myId }) => {
      myIdEl.textContent = myId;
    });

    // Roster rendered from SL (client core converts localRoster -> roster)
    SL.on("roster", list => {
      peersEl.innerHTML = "";
      peerSelect.innerHTML = "<option value=''>Select peer</option>";
      list.forEach(p => {
        const d = document.createElement("div");
        d.className = "peer";
        d.textContent = `${p.name} — ${p.id.slice(0,6)}`;
        d.onclick = () => { peerSelect.value = p.id; };
        peersEl.appendChild(d);

        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name} (${p.id.slice(0,6)})`;
        peerSelect.appendChild(opt);
      });
    });

    // Progress / status
    SL.on("send:progress", e => {
      statusEl.textContent = `Sending ${e.name}: ${e.pct.toFixed(1)}% at ${e.rateMbps.toFixed(2)} Mbps`;
    });
    SL.on("recv:file:progress", e => {
      statusEl.textContent = `Receiving: ${e.pct.toFixed(1)}%`;
    });
    SL.on("recv:file:done", e => {
      statusEl.textContent = `Received ${e.meta.name}`;
    });
    SL.on("error", e => {
      console.warn("SL error:", e);
      statusEl.textContent = `Error: ${e.error?.message || e.error || e.scope || 'Unknown'}`;
    });

    // Actions
    pickBtn.onclick = () => fileInput.click();
    fileInput.onchange = async () => {
      const peerId = peerSelect.value;
      if (!peerId) return alert("Select peer first");
      for (const f of fileInput.files) {
        SL.sendFile(peerId, f).catch(err => console.error(err));
      }
    };
    connectBtn.onclick = () => {
      const peerId = peerSelect.value;
      if (!peerId) return alert("Select peer first");
      SL.connect(peerId);
    };
  </script>
</body>
</html>
