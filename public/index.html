<!doctype html>
<html>
  <head><meta charset="utf-8"><title>P2P Test</title></head>
  <body>
    <input id="name" placeholder="Your name" />
    <button id="enter">Enter Local</button>
    <div>
      <ul id="roster"></ul>
    </div>
    <input id="file" type="file" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/streamsaver@2.0.6/StreamSaver.min.js"></script>
    <script src="client.js"></script>
    <script>
      const p2p = createP2PClient({ signalingURL: location.origin });
      const rosterEl = document.getElementById('roster');

      p2p.onRoster(list => {
        rosterEl.innerHTML = '';
        list.forEach(peer => {
          const li = document.createElement('li');
          li.textContent = peer.name + ' (' + peer.id + ') ';
          const btn = document.createElement('button');
          btn.textContent = 'Connect';
          btn.onclick = async () => {
            const conn = await p2p.connect(peer.id);
            conn.on('open', () => console.log('DC open'));
            conn.on('send-progress', p => console.log('send', p.percent + '%'));
            conn.on('recv-progress', p => console.log('recv', p.percent + '%'));

            document.getElementById('file').onchange = async (e) => {
              const f = e.target.files[0];
              await conn.sendFile(f, { chunkSize: 1024 * 1024 }); // 1MB chunks
            };
          };
          li.appendChild(btn);
          rosterEl.appendChild(li);
        });
      });

      document.getElementById('enter').onclick = () => {
        p2p.enterLocal(document.getElementById('name').value || 'Guest');
      };
    </script>
  </body>
</html>
