<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SendLike — P2P File Share</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="wrap">
    <h1>SendLike — P2P File Share (Local WiFi)</h1>
    <p class="muted">Signaling only — file bytes go peer-to-peer via WebRTC.</p>

    <section class="me">
      <div><strong>Your name:</strong> <span id="myName">...</span></div>
      <div><strong>Your id:</strong> <span id="myId">...</span></div>
    </section>

    <section>
      <h2>Peers</h2>
      <div id="peers" class="peers"></div>
    </section>

    <section>
      <h2>Transfer</h2>
      <div class="controls">
        <input id="fileInput" type="file" multiple hidden>
        <button id="pickFileBtn">Pick file(s)</button>
        <select id="peerSelect"><option value="">Select peer</option></select>
        <button id="connectBtn">Connect / Offer</button>
        <div id="status" class="status">Idle</div>
      </div>
      <div id="transfers" class="transfers"></div>
    </section>

    <footer class="muted small">
      Uses WebRTC DataChannel (STUN only by default). If NAT traversal fails you will need a TURN server.
    </footer>
  </main>

  <!-- Socket.io client -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- SendLike P2P core -->
  <script src="script.js"></script>

  <script>
    // --- Bind UI to SL core ---
    const myNameEl   = document.getElementById("myName");
    const myIdEl     = document.getElementById("myId");
    const peersEl    = document.getElementById("peers");
    const peerSelect = document.getElementById("peerSelect");
    const pickFileBtn= document.getElementById("pickFileBtn");
    const fileInput  = document.getElementById("fileInput");
    const connectBtn = document.getElementById("connectBtn");
    const statusEl   = document.getElementById("status");
    const transfersEl= document.getElementById("transfers");

    // Init SendLike core
    const { name } = SL.init();
    myNameEl.textContent = name;

    // Show ID once connected
    SL.on("connected", () => {
      if (SL.state?.myId) {
        myIdEl.textContent = SL.state.myId.slice(0,6); // show only first 6 chars
      }
    });

    // Update peer list
    SL.on("roster", list => {
      peersEl.innerHTML = "";
      peerSelect.innerHTML = "<option value=''>Select peer</option>";
      list.forEach(p => {
        const d = document.createElement("div");
        d.className = "peer";
        d.textContent = `${p.name} — ${p.id.slice(0,6)}`;
        d.onclick = () => { peerSelect.value = p.id; };
        peersEl.appendChild(d);

        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name} (${p.id.slice(0,6)})`;
        peerSelect.appendChild(opt);
      });
    });

    // Progress + status
    SL.on("send:progress", e => {
      statusEl.textContent = `Sending ${e.name}: ${e.pct.toFixed(1)}% at ${e.rateMbps.toFixed(2)} Mbps`;
    });
    SL.on("recv:file:progress", e => {
      statusEl.textContent = `Receiving: ${e.pct.toFixed(1)}%`;
    });
    SL.on("recv:file:done", e => {
      statusEl.textContent = `Received ${e.meta.name}`;
    });

    // File send
    pickFileBtn.onclick = () => fileInput.click();
    fileInput.onchange = async () => {
      const peerId = peerSelect.value;
      if (!peerId) return alert("Select peer first");
      for (const f of fileInput.files) {
        SL.sendFile(peerId, f).catch(err => console.error(err));
      }
    };

    // Manual connect
    connectBtn.onclick = () => {
      const peerId = peerSelect.value;
      if (!peerId) return alert("Select peer first");
      SL.connect(peerId);
    };
  </script>
</body>
</html>
