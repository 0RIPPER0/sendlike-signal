<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SendLike</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset & Base ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --vio1:#a18cd1; --vio2:#fbc2eb; --ink:#0f172a;
      --card:rgba(255,255,255,0.25); --glass:blur(14px);
      --stroke:rgba(255,255,255,0.34); --shadow:0 10px 30px rgba(0,0,0,.12);
      --muted:#6b7280; --accent:#7c3aed;
      --ok:#16a34a; --danger:#ef4444;
    }
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      color:var(--ink);
      min-height:100vh; overflow-x:hidden;
      display:flex; justify-content:center; align-items:flex-start; padding:24px;
      background: linear-gradient(135deg,#d6c6f4,#efe5ff);
    }
    /* Spirals + Grid */
    body::before, body::after{content:""; position:fixed; inset:0; z-index:-2}
    body::before{background:conic-gradient(from 0deg, rgba(255,255,255,.06) 0deg, transparent 120deg); animation:spin 40s linear infinite;}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    body::after{
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 46px 46px;
      animation: drift 24s linear infinite;
    }
    @keyframes drift{0%{background-position:0 0,0 0}100%{background-position:46px 46px,46px 46px}}

    /* ===== Landing (one smooth takeoff) ===== */
    #landing{
      position:fixed; inset:0; z-index:999;
      background: radial-gradient(1200px 600px at 10% 10%,rgba(255,255,255,.25),transparent),
                  linear-gradient(135deg,var(--vio1),var(--vio2));
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      transition:opacity 1s ease;
    }
    #tagWrap{padding:0 22px}
    #tagline{
      color:white; text-align:center; line-height:1.4;
      font-size: clamp(16px, 4.2vw, 22px); font-weight:700;
      max-width: 720px;
    }
    .plane{
      display:inline-block; font-size: clamp(18px, 5vw, 24px); vertical-align:baseline;
      animation: planeCurve 1.6s ease-in forwards;
    }
    .contrail{
      position:absolute; width:340px; height:90px; border-top:3px solid rgba(255,255,255,.75);
      border-radius:50% 50% 0 0; top:50%; left:calc(50% - 170px);
      transform-origin:left center; animation: contrailFade 1.6s ease-in forwards;
    }
    @keyframes planeCurve{
      0%{transform:translate(0,0) rotate(0) scale(1); opacity:1}
      45%{transform:translate(120px,-24px) rotate(10deg) scale(1)}
      85%{transform:translate(260px,-70px) rotate(18deg) scale(.92); opacity:.95}
      100%{transform:translate(330px,-130px) rotate(24deg) scale(.86); opacity:0}
    }
    @keyframes contrailFade{
      0%{opacity:.7; transform:scaleX(0)}
      30%{transform:scaleX(1); opacity:.6}
      90%{opacity:.25}
      100%{opacity:0; transform:scaleX(1.2)}
    }

    /* ===== App Layout ===== */
    .container{display:grid; gap:16px; width:100%; max-width:780px}
    header{display:flex; justify-content:space-between; align-items:center}
    header h1{display:flex; align-items:center; gap:10px; font-size:22px; font-weight:900; letter-spacing:.2px}
    header img{width:40px;height:40px}
    .card{
      background:var(--card); backdrop-filter:var(--glass);
      border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow); padding:16px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .stack{display:grid; gap:12px}

    /* Inputs */
    input,select{
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,.55); backdrop-filter: blur(6px);
      font-size:14px; width:100%;
    }

    /* Buttons (glass gradient + hover) */
    button{
      position:relative; padding:10px 16px; border:none; border-radius:14px;
      background:linear-gradient(135deg, rgba(255,255,255,.3), rgba(255,255,255,.12));
      font-weight:800; color:#1f2937; cursor:pointer; transition:.25s;
    }
    button:hover{background:linear-gradient(135deg, rgba(255,255,255,.6), rgba(255,255,255,.25)); transform:translateY(-1px)}
    button:active{transform:scale(.98)}
    button.primary{color:white; background:linear-gradient(135deg,#6d28d9,#9333ea)}
    button.primary:hover{background:linear-gradient(135deg,#7c3aed,#a855f7)}
    .danger{background:linear-gradient(135deg,#f87171,#ef4444); color:white}

    /* Peers grid */
    .peers{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top:10px}
    .peer{
      display:grid; grid-template-columns:44px 1fr; gap:10px; align-items:center;
      padding:10px; border-radius:14px; border:1px dashed rgba(255,255,255,.5);
      background:rgba(255,255,255,.35);
      cursor:pointer; transition:.2s;
    }
    .peer:hover{background:rgba(255,255,255,.55)}
    .peer.me{opacity:.65}
    .peer .avatar{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(135deg,#8b5cf6,#c084fc); color:white; font-weight:900;
    }
    .small{font-size:12px; color:var(--muted)}

    /* Progress bars */
    .progress{height:12px; background:rgba(255,255,255,.35); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.5)}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#a3e635)}

    /* Floating chat bubble */
    #chatBubble{
      position:fixed; right:18px; bottom:18px; z-index:50;
      width:48px; height:48px; border-radius:999px; display:grid; place-items:center;
      background:linear-gradient(135deg,#ffffffaa,#ffffff66); border:1px solid var(--stroke); backdrop-filter:var(--glass);
      box-shadow:var(--shadow); cursor:pointer; font-size:22px;
    }
    #chatPanel{
      position:fixed; right:18px; bottom:78px; width:320px; max-width:calc(100vw - 36px);
      background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow);
      backdrop-filter:var(--glass); padding:12px; display:none; z-index:50;
    }
    #msgs{height:220px; overflow-y:auto; background:rgba(255,255,255,.45); border-radius:12px; padding:10px; margin-bottom:10px}
    .msg{margin:6px 0; font-size:14px}
    .msg.me b{color:var(--accent)}

    footer{margin-top:6px; text-align:center; font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    @media (max-width:600px){ .container{max-width:100%; padding:4px} }
  </style>
</head>
<body>

  <!-- Landing (one-time smooth takeoff) -->
  <div id="landing">
    <div id="tagWrap">
      <h1 id="tagline">
        Fast enough to make your WIFI blush‚Ä¶<br/>
        Because your file deserve a First Class <span class="plane" aria-label="plane" role="img">‚úàÔ∏è</span>
      </h1>
      <span class="contrail" aria-hidden="true"></span>
    </div>
  </div>

  <!-- App -->
  <div class="container" id="app" style="display:none">
    <!-- Header -->
    <header>
      <h1><img src="icon.png" alt="logo"> SendLike</h1>
      <button id="aboutBtn">About</button>
    </header>

    <!-- Mode + TTL -->
    <div class="card row" style="justify-content:space-between; align-items:center">
      <div class="row" style="align-items:center">
        <span>üåê Online</span>
        <label class="row" style="align-items:center">
          <input type="checkbox" id="modeToggle" style="margin:0 10px">
        </label>
        <span>üì° Local</span>
      </div>
      <div class="row">
        <span class="muted">Session limit:</span>
        <select id="sessionLimit">
          <option value="10">10 min</option>
          <option value="30">30 min</option>
          <option value="60">1 hour</option>
          <option value="0">No limit</option>
        </select>
      </div>
    </div>

    <!-- Join Group -->
    <div class="card">
      <h2>Online (Join with Code)</h2>
      <div class="stack" style="margin-top:8px">
        <input id="nameInput" type="text" placeholder="Your name">
        <div class="row">
          <input id="codeInput" type="text" placeholder="6-digit code" maxlength="6">
          <button id="joinBtn" class="primary">Join Group</button>
        </div>
        <div class="progress" id="progressJoin" style="display:none"><div class="bar" id="barJoin"></div></div>
      </div>
    </div>

    <!-- Create Group -->
    <div class="card">
      <h2>Create a New Group</h2>
      <div class="stack" style="margin-top:8px">
        <input id="hostName" type="text" placeholder="Your name">
        <button id="createBtn" class="primary">Create Group</button>
        <div class="progress" id="progressCreate" style="display:none"><div class="bar" id="barCreate"></div></div>
      </div>
    </div>

    <!-- Group Area -->
    <div id="groupArea" class="card" style="display:none">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="muted">Group Code</div>
          <div style="font-size:28px;font-weight:900;letter-spacing:2px" id="groupCode">------</div>
          <div class="small" id="expires">no limit</div>
        </div>
        <div class="stack" style="min-width:220px">
          <input type="file" id="fileAll">
          <button id="sendAll" class="primary">Send to All</button>
          <button id="disband" class="danger" style="display:none">Disband Group</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">Members</div>
      <div class="peers" id="peersOnline"></div>

      <!-- Transfer progress -->
      <div class="stack" id="progressWrap" style="margin-top:10px; display:none">
        <div id="progressTitle" class="small">Sending‚Ä¶</div>
        <div class="progress"><div class="bar" id="progressBar"></div></div>
        <div id="speedLine" class="small muted"></div>
      </div>
    </div>

    <!-- Local Area -->
    <div id="localArea" class="card" style="display:none">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div class="stack" style="min-width:220px">
          <input id="nameLocal" type="text" placeholder="Your name (auto if empty)">
          <div class="row">
            <button id="enterLocal" class="primary">Enter Local</button>
            <button id="leaveLocal" style="display:none">Leave</button>
          </div>
          <input type="file" id="fileLocal">
          <button id="sendAllLocal" class="primary">Send to All Local</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">Nearby Devices</div>
      <div class="peers" id="peersLocal"></div>

      <div class="stack" id="progressWrapLocal" style="margin-top:10px; display:none">
        <div id="progressTitleLocal" class="small">Sending‚Ä¶</div>
        <div class="progress"><div class="bar" id="progressBarLocal"></div></div>
        <div id="speedLineLocal" class="small muted"></div>
      </div>
    </div>

    <footer>Made by You ü§ù with a little help from ChatGPT</footer>
  </div>

  <!-- Chat bubble + panel -->
  <button id="chatBubble" title="Chat">üí¨</button>
  <div id="chatPanel">
    <div class="row" style="justify-content:space-between; align-items:center">
      <strong>Group Chat</strong>
      <button id="closeChat">‚úï</button>
    </div>
    <div id="msgs"></div>
    <div class="row">
      <input id="chatInput" placeholder="Type a message‚Ä¶">
      <button id="chatSend" class="primary">Send</button>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    /* ================= Landing fade once ================= */
    window.addEventListener('load', () => {
      setTimeout(() => {
        const L = document.getElementById('landing');
        L.style.opacity = '0';
        setTimeout(() => {
          L.style.display = 'none';
          document.getElementById('app').style.display = 'grid';
        }, 1000);
      }, 2200);
    });

    /* ================= Helpers ================= */
    const $ = id => document.getElementById(id);
    function shortId(id){ return (id||"").slice(0,6).toUpperCase(); }
    function fmt(b){ if (b<1024) return b+" B"; const u=["KB","MB","GB","TB"]; let i=-1; do{ b/=1024; i++; } while(b>=1024 && i<u.length-1); return b.toFixed(1)+" "+u[i]; }

    function cuteName(){
      const adj=["Golden","Sunny","Peachy","Bouncy","Chill","Lucky","Happy","Swift","Minty","Cozy","Snappy","Jazzy"];
      const nouns=["Mango","Panda","Tiger","Dolphin","Falcon","Owl","Otter","Koala","Yak","Robin","Lynx","Orca"];
      return `${adj[Math.floor(Math.random()*adj.length)]} ${nouns[Math.floor(Math.random()*nouns.length)]}`;
    }

    /* ================= State ================= */
    const socket = io();
    let group = { code:null, isHost:false, expiresAt:0, members:[] };
    let localState = { roster: [] };
    const peers = {};   // id -> RTCPeerConnection
    const channels = {}; // id -> RTCDataChannel

    /* ================= UI wiring ================= */
    $('aboutBtn').onclick = () => alert('SendLike ‚Äî Simple P2P sharing via code or local network.');
    $('chatBubble').onclick = () => $('chatPanel').style.display = $('chatPanel').style.display==='none'?'block':'none';
    $('closeChat').onclick = () => $('chatPanel').style.display = 'none';
    $('chatSend').onclick = sendChat;

    $('createBtn').onclick = createGroup;
    $('joinBtn').onclick = joinGroup;
    $('sendAll').onclick = () => {
      const f = $('fileAll').files[0]; if(!f) return alert('Choose a file');
      const targets = group.members.filter(m=>m.id!==socket.id).map(m=>m.id);
      sendFile(targets, f, 'online');
    };
    $('enterLocal').onclick = () => {
      const name = ($('nameLocal').value.trim() || cuteName());
      $('nameLocal').value = name;
      socket.emit('enterLocal', name);
      $('enterLocal').style.display='none';
      $('leaveLocal').style.display='inline-block';
      $('localArea').querySelector('.muted').textContent = 'Discovering devices on LAN‚Ä¶';
      joinChatRoom('local', name);
    };
    $('leaveLocal').onclick = () => {
      socket.emit('leaveLocal');
      $('enterLocal').style.display='inline-block';
      $('leaveLocal').style.display='none';
      $('localArea').querySelector('.muted').textContent = 'Nearby Devices';
    };
    $('sendAllLocal').onclick = ()=>{
      const f = $('fileLocal').files[0]; if(!f) return alert('Choose a file');
      const targets = localState.roster.filter(p=>p.id!==socket.id).map(p=>p.id);
      sendFile(targets, f, 'local');
    };

    // Mode toggle: unchecked=Online, checked=Local
    $('modeToggle').addEventListener('change', function(){
      const localOn = this.checked;
      $('localArea').style.display = localOn ? 'block' : 'none';
      $('groupArea').style.display  = localOn ? 'none'  : (group.code ? 'block' : 'none');
      if (!localOn) socket.emit('leaveLocal');
    });

    /* ================= Online: create/join ================= */
    function formatTime(ts){
      if(!ts) return 'no limit';
      const left=ts-Date.now(); if(left<=0) return 'expired';
      const m=Math.floor(left/60000), s=Math.floor((left%60000)/1000);
      return `${m}:${String(s).padStart(2,'0')} left`;
    }

    function createGroup(){
      const name = $('hostName').value.trim();
      if(!name) return alert('Enter your name');
      const ttlMinutes = parseInt($('sessionLimit').value,10);
      $('progressCreate').style.display='block';
      animateBar($('barCreate'));
      group.isHost = true;
      socket.emit('createGroup',{name, ttlMinutes}, ({code,expiresAt})=>{
        group.code = code; group.expiresAt=expiresAt; $('groupCode').textContent=code;
        $('expires').textContent = ttlMinutes ? 'Expires in '+formatTime(expiresAt) : 'Unlimited';
        $('groupArea').style.display='block';
        $('disband').style.display='inline-block';
        joinChatRoom(code, name);
        stopBar($('progressCreate'), $('barCreate'));
      });
    }

    function joinGroup(){
      const name = $('nameInput').value.trim();
      const code = $('codeInput').value.trim();
      if(!name || !code) return alert('Enter name and code');
      $('progressJoin').style.display='block';
      animateBar($('barJoin'));
      socket.emit('joinGroup',{name, code}, (res)=>{
        if(res?.error){ stopBar($('progressJoin'), $('barJoin')); return alert(res.error); }
        group.code=code; group.expiresAt=res.expiresAt; group.isHost=false;
        $('groupCode').textContent=code;
        $('expires').textContent = res.expiresAt ? 'Expires in '+formatTime(res.expiresAt) : 'Unlimited';
        $('groupArea').style.display='block';
        $('disband').style.display='none';
        joinChatRoom(code, name);
        stopBar($('progressJoin'), $('barJoin'));
      });
    }
    $('disband').onclick = ()=> socket.emit('disbandGroup', group.code);
    socket.on('groupDisbanded', (reason='Group closed')=>{
      alert(reason);
      group = { code:null, isHost:false, expiresAt:0, members:[] };
      $('groupArea').style.display='none';
    });

    socket.on('updateMembers', (list)=>{ group.members=list; renderOnlinePeers(); });

    function renderOnlinePeers(){
      const wrap = $('peersOnline'); wrap.innerHTML='';
      group.members.forEach(m=>{
        const d=document.createElement('div'); d.className='peer'+(m.id===socket.id?' me':''); d.dataset.id=m.id;
        d.innerHTML = `
          <div class="avatar">${(m.name||'?').slice(0,1).toUpperCase()}</div>
          <div>
            <div><strong>${m.name||'?'}</strong></div>
            <div class="small">${shortId(m.id)}</div>
          </div>`;
        d.addEventListener('click', async ()=>{ if (m.id!==socket.id) await connectTo(m.id); });
        d.addEventListener('dragenter', e=>{e.preventDefault(); d.style.borderColor='#a78bfa';});
        d.addEventListener('dragover', e=>e.preventDefault());
        d.addEventListener('dragleave', ()=> d.style.borderColor='rgba(255,255,255,.5)');
        d.addEventListener('drop', e=>{
          e.preventDefault(); d.style.borderColor='rgba(255,255,255,.5)';
          const f=e.dataTransfer?.files?.[0]; if(f) sendFile([m.id], f, 'online');
        });
        wrap.appendChild(d);
      });
      group.members.forEach(m=>{ if(m.id!==socket.id && !peers[m.id]) connectTo(m.id); });
    }

    /* ================= Local discovery ================= */
    socket.on('localRoster', (roster)=>{ localState.roster=roster; renderLocalPeers(); });
    function renderLocalPeers(){
      const wrap = $('peersLocal'); wrap.innerHTML='';
      localState.roster.forEach(p=>{
        const d=document.createElement('div'); d.className='peer'+(p.id===socket.id?' me':''); d.dataset.id=p.id;
        d.innerHTML = `
          <div class="avatar">${(p.name||'?').slice(0,1).toUpperCase()}</div>
          <div>
            <div><strong>${p.name||'?'}</strong></div>
            <div class="small">${shortId(p.id)}</div>
          </div>`;
        d.addEventListener('click', async ()=>{ if (p.id!==socket.id) await connectTo(p.id); });
        d.addEventListener('dragenter', e=>{e.preventDefault(); d.style.borderColor='#a78bfa';});
        d.addEventListener('dragover', e=>e.preventDefault());
        d.addEventListener('dragleave', ()=> d.style.borderColor='rgba(255,255,255,.5)');
        d.addEventListener('drop', e=>{
          e.preventDefault(); d.style.borderColor='rgba(255,255,255,.5)';
          const f=e.dataTransfer?.files?.[0]; if(f) sendFile([p.id], f, 'local');
        });
        wrap.appendChild(d);
      });
      localState.roster.forEach(p=>{ if(p.id!==socket.id && !peers[p.id]) connectTo(p.id); });
    }

    /* ================= Chat ================= */
    function currentRoom(){ return ($('modeToggle').checked ? 'local' : (group.code || 'lobby')); }
    function joinChatRoom(room, name){
      socket.emit('chat', { room, name, text: `${name} joined` });
      $('chatBubble').style.display='grid';
    }
    function appendMsg({me, name, text}){
      const d=document.createElement('div'); d.className='msg'+(me?' me':'');
      d.innerHTML = `<b>${name}:</b> ${escapeHtml(text)}`;
      $('msgs').appendChild(d);
      $('msgs').scrollTop = $('msgs').scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function sendChat(){
      const text = $('chatInput').value.trim(); if(!text) return;
      const name = $('nameInput').value.trim() || $('hostName').value.trim() || $('nameLocal').value.trim() || 'Me';
      socket.emit('chat', { room: currentRoom(), name, text });
      appendMsg({ me:true, name, text }); $('chatInput').value='';
    }
    socket.on('chat', (m)=>{ if (m.id===socket.id) return; appendMsg({ me:false, name:m.name, text:m.text }); });

    /* ================= WebRTC base ================= */
    function ensurePeer(targetId){
      if (peers[targetId]) return peers[targetId];
      const pc = new RTCPeerConnection({ iceServers: [] });
      peers[targetId] = pc;
      if (socket.id < targetId) { const ch = pc.createDataChannel('file'); setupChannel(targetId, ch); }
      pc.ondatachannel = (e) => setupChannel(targetId, e.channel);
      pc.onicecandidate = (e)=>{ if (e.candidate) socket.emit('signal', { targetId, data:{ candidate:e.candidate }}); };
      return pc;
    }
    function setupChannel(targetId, channel){
      channels[targetId] = channel; channel.binaryType='arraybuffer';
      channel.onopen = ()=>console.log('DC open', targetId);
      channel.onclose = ()=>console.log('DC close', targetId);
      let incoming=null;
      channel.onmessage = (e)=>{
        if (typeof e.data === 'string'){
          const meta = JSON.parse(e.data);
          if (meta.type==='meta'){
            incoming = { name:meta.name, size:meta.size, chunks:[], received:0, scope:meta.scope };
            showProgress(meta.scope, `Receiving ${meta.name}`, 0, 0, meta.size);
            playReceive();
          }
        } else {
          if (!incoming) return;
          incoming.chunks.push(e.data);
          incoming.received += e.data.byteLength;
          showProgress(incoming.scope, `Receiving ${incoming.name}`, incoming.received/incoming.size*100, incoming.received, incoming.size);
          if (incoming.received >= incoming.size){
            const blob = new Blob(incoming.chunks); const url = URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download=incoming.name; a.click();
            hideProgress(incoming.scope); incoming=null;
          }
        }
      };
    }
    socket.on('signal', async ({ from, data }) => {
      const pc = ensurePeer(from);
      if (data.desc){
        await pc.setRemoteDescription(data.desc);
        if (data.desc.type==='offer'){
          const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
          socket.emit('signal', { targetId: from, data:{ desc: pc.localDescription }});
        }
      } else if (data.candidate){
        try{ await pc.addIceCandidate(data.candidate); }catch(e){ console.warn(e); }
      }
    });
    async function connectTo(targetId){
      const pc = ensurePeer(targetId);
      const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
      socket.emit('signal', { targetId, data:{ desc: pc.localDescription }});
    }

    /* ================= Send + Progress + SFX ================= */
    function sendFile(targetIds, file, scope){
      const outs = targetIds.map(id=>channels[id]).filter(ch=>ch && ch.readyState==='open');
      if (outs.length===0){ alert('No connected peers yet. Tap a device bubble to connect, then try again.'); return; }
      const meta = JSON.stringify({ type:'meta', name:file.name, size:file.size, scope });
      outs.forEach(ch=>ch.send(meta));
      playSend();
      const reader = file.stream().getReader();
      let sent=0, total=file.size;
      const pump = () => reader.read().then(({done, value})=>{
        if (done){ hideProgress(scope); return; }
        let offset=0;
        while (offset < value.byteLength){
          const chunk = value.buffer.slice(value.byteOffset + offset, value.byteOffset + Math.min(offset + 64*1024, value.byteLength));
          outs.forEach(ch=>ch.send(chunk));
          sent += chunk.byteLength; offset += 64*1024;
        }
        showProgress(scope, `Sending ${file.name}`, sent/total*100, sent, total);
        pump();
      });
      showProgress(scope, `Sending ${file.name}`, 0, 0, total);
      pump();
    }

    function showProgress(scope, title, pct, bytes, total=0){
      const wrap = scope==='online' ? $('progressWrap') : $('progressWrapLocal');
      const bar  = scope==='online' ? $('progressBar')  : $('progressBarLocal');
      const t    = scope==='online' ? $('progressTitle'): $('progressTitleLocal');
      const s    = scope==='online' ? $('speedLine')    : $('speedLineLocal');
      wrap.style.display='grid';
      bar.style.width = `${Math.max(0,Math.min(100,pct)).toFixed(1)}%`;
      t.textContent = title;
      if (total) s.textContent = `${fmt(bytes)} / ${fmt(total)}`;
      if (pct===0){ rocketAcross(); }
    }
    function hideProgress(scope){ (scope==='online' ? $('progressWrap') : $('progressWrapLocal')).style.display='none'; }
    function rocketAcross(){
      const r=document.createElement('div'); r.textContent='üöÄ';
      Object.assign(r.style,{position:'fixed', left:'-40px', top:'30%', fontSize:'28px', transition:'transform 1.6s ease-in-out', zIndex:9999});
      document.body.appendChild(r);
      requestAnimationFrame(()=>{ r.style.transform = `translateX(${window.innerWidth+80}px)`; });
      setTimeout(()=>r.remove(),1700);
    }
    function playSend(){
      try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='triangle'; o.frequency.setValueAtTime(440, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(880, ctx.currentTime+.15);
        g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.045, ctx.currentTime+.05); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+.25);
        o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.26);}catch{}
    }
    function playReceive(){
      try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(660, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(330, ctx.currentTime+.2);
        g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.035, ctx.currentTime+.05); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+.28);
        o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.3);}catch{}
    }
    function animateBar(barEl){
      let w=0; barEl.style.width='0%';
      barEl._int = setInterval(()=>{ w = Math.min(90, w+2); barEl.style.width = w+'%'; }, 80);
    }
    function stopBar(wrapEl, barEl){
      clearInterval(barEl._int); barEl.style.width='100%';
      setTimeout(()=>{ wrapEl.style.display='none'; barEl.style.width='0%'; }, 300);
    }

    /* ================= Global drag-to-send onto members ================= */
    document.addEventListener('dragover', e=>e.preventDefault());
    document.addEventListener('drop', e=>{
      const f = e.dataTransfer?.files?.[0]; if(!f) return;
      const onlineVisible = $('groupArea').style.display !== 'none';
      if (onlineVisible && group.code){
        const targets = group.members.filter(m=>m.id!==socket.id).map(m=>m.id);
        sendFile(targets, f, 'online');
      } else if ($('localArea').style.display!=='none'){
        const targets = localState.roster.filter(p=>p.id!==socket.id).map(p=>p.id);
        sendFile(targets, f, 'local');
      }
    });

  </script>
</body>
</html>
